<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPW Climate Data Analyzer by ASBEE</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for plotting results -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Plotly.js for heatmaps -->
    <script src="https://cdn.plot.ly/plotly-2.33.0.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Custom scrollbar for data table */
        #table-container::-webkit-scrollbar { width: 8px; }
        #table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        #table-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #table-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* Ensure chart container takes up available space */
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chart-container {
            flex-grow: 1;
            position: relative;
        }
        /* Styling for details/summary element */
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] .arrow {
            transform: rotate(90deg);
        }

    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <!-- Left Control Panel -->
    <div class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 shadow-lg overflow-y-auto flex flex-col">
        <div class="flex-grow">
            <img src="logo1.jpeg" alt="ASBEE Logo" class="h-16 w-auto object-contain mx-auto mb-4">
            <h1 class="text-2xl font-bold text-gray-800 text-center">EPW Data Analyzer</h1>
            <p class="text-sm text-gray-600 text-center mt-1 mb-6">
                Upload an EPW weather file to visualize and analyze its hourly data.
            </p>

            <div id="notification" class="hidden p-3 rounded-lg text-sm text-white transition-opacity mb-4"></div>

            <!-- File Input -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload EPW File</label>
                    <input type="file" id="epw-file-input" accept=".epw" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                    <p id="epw-file-name" class="text-xs text-gray-500 mt-1 truncate"></p>
                </div>
                <button id="process-btn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 flex items-center justify-center space-x-2" disabled>
                    <span>Process File</span>
                    <svg id="process-spinner" class="spinner h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
            
            <!-- IMAC Comfort Model Inputs -->
            <div id="imac-section" class="mt-6 hidden">
                <details class="border rounded-lg">
                    <summary class="p-3 font-semibold text-gray-700 flex justify-between items-center">
                        <span>IMAC Comfort Limits (°C)</span>
                        <svg class="w-5 h-5 arrow transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg>
                    </summary>
                    <div class="p-4 border-t bg-gray-50 grid grid-cols-3 gap-x-2 gap-y-3 text-sm">
                        <label class="font-medium col-span-1 text-center">Month</label>
                        <label class="font-medium text-center">Lower</label>
                        <label class="font-medium text-center">Upper</label>
                        <!-- Month inputs will be generated by script -->
                    </div>
                    <div id="imac-inputs" class="p-4 border-t bg-gray-50 grid grid-cols-3 gap-x-2 gap-y-3 text-sm">
                         <!-- JS will populate this -->
                    </div>
                    <div class="p-3 border-t bg-gray-50 flex justify-end">
                        <button id="update-imac-btn" class="bg-green-600 text-white text-sm font-semibold py-1.5 px-4 rounded-md hover:bg-green-700">Apply Limits</button>
                    </div>
                </details>
            </div>


            <!-- Tab Navigation -->
            <div id="tabs" class="border-b border-gray-200 mt-8 hidden">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button data-tab="hourly" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm border-blue-500 text-blue-600">Hourly Chart</button>
                    <button data-tab="heatmap" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Heatmap</button>
                    <button data-tab="summary" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Summary</button>
                </nav>
            </div>
        </div>

        <!-- About Section -->
        <div class="mt-6 pt-4 border-t border-gray-200">
             <h3 class="font-semibold text-gray-700">About This Tool</h3>
             <p class="text-xs text-gray-500 mt-1">This tool parses standard EnergyPlus Weather (EPW) files to extract the 8760 hourly values for Dry Bulb Temperature and Relative Humidity. It provides basic visualizations and statistics for climate analysis. Developed by ASBEE with AI assistance.</p>
        </div>
    </div>

    <!-- Right Content Panel -->
    <div class="w-full md:w-2/3 lg:w-3/4 bg-gray-50 p-4 md:p-8 main-content overflow-y-auto">
        <!-- Placeholder -->
        <div id="placeholder" class="flex flex-col items-center justify-center h-full text-center">
             <svg class="w-24 h-24 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.15 4.5a3 3 0 0 0-3 3v9a3 3 0 0 0 3 3h17.7a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3H3.15Zm2.55 0a1.5 1.5 0 0 0-1.5 1.5v12a1.5 1.5 0 0 0 1.5 1.5h15.6a1.5 1.5 0 0 0 1.5-1.5v-12a1.5 1.5 0 0 0-1.5-1.5H5.7Zm2.1 4.5a.75.75 0 0 1 .75-.75h6.3a.75.75 0 0 1 0 1.5H8.55a.75.75 0 0 1-.75-.75Zm0 3.75a.75.75 0 0 1 .75-.75h3.3a.75.75 0 0 1 0 1.5H8.55a.75.75 0 0 1-.75-.75Z" />
             </svg>
            <h2 class="mt-4 text-xl font-semibold text-gray-600">Climate Data Visualization</h2>
            <p class="mt-1 text-gray-500">Please upload an EPW file to begin.</p>
        </div>

        <!-- Content Panels -->
        <div id="hourly-panel" class="tab-panel hidden flex flex-col h-full gap-4">
            <div class="flex-1 relative p-4 bg-white rounded-lg shadow">
                <canvas id="temp-chart"></canvas>
            </div>
            <div class="flex-1 relative p-4 bg-white rounded-lg shadow">
                <canvas id="humidity-chart"></canvas>
            </div>
        </div>
        
        <div id="heatmap-panel" class="tab-panel hidden flex flex-col h-full gap-4">
            <!-- Controls -->
            <div class="flex-shrink-0 bg-white p-3 rounded-lg shadow flex flex-wrap items-center justify-center gap-x-6 gap-y-3">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Temp (°C):</label>
                    <input type="number" id="temp-min-input" placeholder="Min" class="w-20 p-1 border rounded-md text-sm">
                    <input type="number" id="temp-max-input" placeholder="Max" class="w-20 p-1 border rounded-md text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Humidity (%):</label>
                    <input type="number" id="humidity-min-input" placeholder="Min" class="w-20 p-1 border rounded-md text-sm">
                    <input type="number" id="humidity-max-input" placeholder="Max" class="w-20 p-1 border rounded-md text-sm">
                </div>
                <div class="flex items-center gap-2">
                     <button id="update-heatmap-btn" class="bg-blue-500 text-white text-sm font-semibold py-1.5 px-3 rounded-md hover:bg-blue-600">Update</button>
                     <button id="reset-heatmap-btn" class="bg-gray-500 text-white text-sm font-semibold py-1.5 px-3 rounded-md hover:bg-gray-600">Reset</button>
                </div>
            </div>
            <!-- Heatmaps -->
            <div id="temp-heatmap" class="flex-1 relative bg-white rounded-lg shadow"></div>
            <div id="humidity-heatmap" class="flex-1 relative bg-white rounded-lg shadow"></div>
        </div>

        <div id="summary-panel" class="tab-panel hidden p-4 bg-white rounded-lg shadow">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Annual Climate Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-lg text-red-700">Temperature (°C)</h3>
                    <ul class="mt-2 space-y-2 text-sm text-gray-700">
                        <li class="flex justify-between"><span>Average:</span> <strong id="avg-temp" class="font-mono">-</strong></li>
                        <li class="flex justify-between"><span>Maximum:</span> <strong id="max-temp" class="font-mono">-</strong></li>
                        <li class="flex justify-between"><span>Minimum:</span> <strong id="min-temp" class="font-mono">-</strong></li>
                    </ul>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-lg text-green-700">Relative Humidity (%)</h3>
                    <ul class="mt-2 space-y-2 text-sm text-gray-700">
                        <li class="flex justify-between"><span>Average:</span> <strong id="avg-humidity" class="font-mono">-</strong></li>
                        <li class="flex justify-between"><span>Maximum:</span> <strong id="max-humidity" class="font-mono">-</strong></li>
                        <li class="flex justify-between"><span>Minimum:</span> <strong id="min-humidity" class="font-mono">-</strong></li>
                    </ul>
                </div>
                 <div class="bg-blue-50 p-4 rounded-lg md:col-span-2">
                    <h3 class="font-semibold text-lg text-blue-700">IMAC Thermal Comfort</h3>
                    <p class="mt-2 text-sm text-gray-700">Percentage of annual hours within the defined IMAC comfort band: <strong id="comfort-percentage" class="text-xl font-mono">-</strong></p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- UI Element References ---
        const epwFileInput = document.getElementById('epw-file-input');
        const epwFileNameEl = document.getElementById('epw-file-name');
        const processBtn = document.getElementById('process-btn');
        const processSpinner = document.getElementById('process-spinner');
        const notificationEl = document.getElementById('notification');
        const placeholder = document.getElementById('placeholder');
        const tabsContainer = document.getElementById('tabs');
        const imacSection = document.getElementById('imac-section');
        const imacInputsContainer = document.getElementById('imac-inputs');
        const updateImacBtn = document.getElementById('update-imac-btn');
        const updateHeatmapBtn = document.getElementById('update-heatmap-btn');
        const resetHeatmapBtn = document.getElementById('reset-heatmap-btn');
        
        // --- State ---
        let epwData = [];
        let tempChart, humidityChart;
        let heatmapDataCache = null;
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        // Default IMAC values (example)
        let imacLimits = {
            0: { lower: 23, upper: 28 }, 1: { lower: 23, upper: 28 }, 2: { lower: 24, upper: 29 }, 
            3: { lower: 25, upper: 30 }, 4: { lower: 26, upper: 31 }, 5: { lower: 26, upper: 31 },
            6: { lower: 25, upper: 30 }, 7: { lower: 25, upper: 30 }, 8: { lower: 25, upper: 30 }, 
            9: { lower: 24, upper: 29 }, 10: { lower: 23, upper: 28 }, 11: { lower: 23, upper: 28 }
        };

        // --- Initial Setup ---
        function initializeImacInputs() {
            imacInputsContainer.innerHTML = '';
            months.forEach((month, index) => {
                imacInputsContainer.innerHTML += `
                    <span class="font-medium text-center self-center">${month}</span>
                    <input type="number" data-month="${index}" data-type="lower" value="${imacLimits[index].lower}" class="imac-input w-full p-1 border rounded-md text-sm text-center">
                    <input type="number" data-month="${index}" data-type="upper" value="${imacLimits[index].upper}" class="imac-input w-full p-1 border rounded-md text-sm text-center">
                `;
            });
        }
        initializeImacInputs();


        // --- Core App Logic ---
        function showNotification(message, isError = false) {
            notificationEl.textContent = message;
            notificationEl.className = `p-3 rounded-lg text-sm text-white transition-opacity mb-4 ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
            notificationEl.classList.remove('hidden');
            setTimeout(() => notificationEl.classList.add('hidden'), 5000);
        }

        epwFileInput.addEventListener('change', () => {
            if (epwFileInput.files.length > 0) {
                epwFileNameEl.textContent = epwFileInput.files[0].name;
                processBtn.disabled = false;
            } else {
                epwFileNameEl.textContent = '';
                processBtn.disabled = true;
            }
        });

        processBtn.addEventListener('click', () => {
            if (epwFileInput.files.length === 0) {
                showNotification("Please select a file first.", true);
                return;
            }
            const file = epwFileInput.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const text = event.target.result;
                    epwData = parseEPW(text);
                    if(epwData.length < 8760) { // Allow for leap years, but check for substantially less data
                        throw new Error(`Expected at least 8760 data rows, but found ${epwData.length}. The EPW file may be incomplete or invalid.`);
                    }
                    showNotification("File processed successfully!", false);
                    placeholder.classList.add('hidden');
                    tabsContainer.classList.remove('hidden');
                    imacSection.classList.remove('hidden');
                    
                    // Clear previous data
                    heatmapDataCache = null;
                    
                    // Populate all data views
                    displayHourlyChart();
                    displayHeatmaps();
                    calculateAndDisplaySummary();
                    
                    // Show the first tab
                    switchTab('hourly');

                } catch (error) {
                    showNotification(error.message, true);
                    console.error("Error processing EPW file:", error);
                } finally {
                    processSpinner.classList.add('hidden');
                    processBtn.disabled = false;
                }
            };
            
            reader.onerror = () => {
                showNotification("Failed to read the file.", true);
                processSpinner.classList.add('hidden');
                processBtn.disabled = false;
            };

            processSpinner.classList.remove('hidden');
            processBtn.disabled = true;
            reader.readAsText(file);
        });

        function parseEPW(text) {
            const lines = text.split('\n').slice(8); // Skip 8 header lines
            return lines.map((line, index) => {
                const fields = line.split(',');
                if (fields.length < 9) return null; // Ensure there are enough columns
                
                const year = 2022; // Use a fixed non-leap year to ensure continuity
                const month = parseInt(fields[1], 10);
                const day = parseInt(fields[2], 10);
                const hour = parseInt(fields[3], 10) - 1; // 1-24 -> 0-23
                
                // Handle potential invalid date entries
                if (isNaN(month) || isNaN(day) || isNaN(hour)) return null;

                const date = new Date(year, month - 1, day, hour);

                return {
                    hourOfYear: index + 1,
                    date: date,
                    temp: parseFloat(fields[6]), // Dry Bulb Temperature in °C
                    humidity: parseFloat(fields[8]), // Relative Humidity in %
                };
            }).filter(Boolean); // Filter out any null (invalid) rows
        }

        updateImacBtn.addEventListener('click', () => {
            document.querySelectorAll('.imac-input').forEach(input => {
                const month = input.dataset.month;
                const type = input.dataset.type;
                imacLimits[month][type] = parseFloat(input.value);
            });
            showNotification("IMAC limits updated.", false);
            // Redraw chart and summary with new limits
            if (epwData.length > 0) {
                 displayHourlyChart();
                 calculateAndDisplaySummary();
            }
        });
        
        // --- Tab Switching ---
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        function switchTab(activeTabId) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.querySelectorAll('.tab-btn').forEach(button => {
                 button.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            
            document.getElementById(`${activeTabId}-panel`).classList.remove('hidden');
            const activeButton = document.querySelector(`[data-tab="${activeTabId}"]`);
            activeButton.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm border-blue-500 text-blue-600';
        }

        // --- Charting Logic ---
        function displayHourlyChart() {
            const tempCtx = document.getElementById('temp-chart').getContext('2d');
            const humidityCtx = document.getElementById('humidity-chart').getContext('2d');

            if (tempChart) tempChart.destroy();
            if (humidityChart) humidityChart.destroy();

            // Calculate monthly averages
            const monthlyAverages = {};
            epwData.forEach(d => {
                const monthKey = d.date.getMonth();
                if (!monthlyAverages[monthKey]) {
                    monthlyAverages[monthKey] = { temps: [], humidities: [] };
                }
                monthlyAverages[monthKey].temps.push(d.temp);
                monthlyAverages[monthKey].humidities.push(d.humidity);
            });

            const monthlyAvgValues = {};
            for (const key in monthlyAverages) {
                const tempSum = monthlyAverages[key].temps.reduce((a, b) => a + b, 0);
                const humiditySum = monthlyAverages[key].humidities.reduce((a, b) => a + b, 0);
                monthlyAvgValues[key] = {
                    temp: tempSum / monthlyAverages[key].temps.length,
                    humidity: humiditySum / monthlyAverages[key].humidities.length,
                };
            }

            // Map monthly averages back to the hourly data structure for plotting
            const monthlyAvgTempData = epwData.map(d => {
                const monthKey = d.date.getMonth();
                return monthlyAvgValues[monthKey].temp;
            });

            const monthlyAvgHumidityData = epwData.map(d => {
                const monthKey = d.date.getMonth();
                return monthlyAvgValues[monthKey].humidity;
            });

            // Prepare IMAC datasets
            const imacLowerData = epwData.map(d => imacLimits[d.date.getMonth()].lower);
            const imacUpperData = epwData.map(d => imacLimits[d.date.getMonth()].upper);

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                        },
                        title: { display: false } // X-axis title can be omitted as it's clear
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (context) => {
                                 const date = new Date(context[0].parsed.x);
                                 const month = date.toLocaleString('default', { month: 'short' });
                                 const day = date.getDate();
                                 const hour = date.getHours().toString().padStart(2, '0');
                                 return `${month} ${day}, ${hour}:00`;
                            }
                        }
                    },
                    legend: { display: true }
                }
            };

            // Temperature Chart
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: epwData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Temperature',
                            data: epwData.map(d => d.temp),
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: 'start',
                            order: 2
                        },
                        {
                            label: 'Monthly Average',
                            data: monthlyAvgTempData,
                            borderColor: 'rgb(0, 0, 0)',
                            borderWidth: 2,
                            pointRadius: 0,
                            stepped: 'before',
                            fill: false,
                            order: 0
                        },
                        {
                            label: 'IMAC Lower Limit',
                            data: imacLowerData,
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                             borderDash: [5, 5],
                            order: 1
                        },
                        {
                            label: 'IMAC Upper Limit',
                            data: imacUpperData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: '-1', // Fill to the previous dataset (lower limit)
                             borderDash: [5, 5],
                            order: 1
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: { ...commonOptions.scales, y: { type: 'linear', title: { display: true, text: '°C' }}},
                    plugins: { ...commonOptions.plugins, title: { display: true, text: 'Hourly Temperature & IMAC Comfort Band', font: { size: 16 }}}
                }
            });
            
            // Humidity Chart
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: epwData.map(d => d.date),
                    datasets: [{
                        label: 'Humidity',
                        data: epwData.map(d => d.humidity),
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: 'start',
                        order: 1
                    },
                    {
                        label: 'Monthly Average',
                        data: monthlyAvgHumidityData,
                        borderColor: 'rgb(0, 0, 0)',
                        borderWidth: 2,
                        pointRadius: 0,
                        stepped: 'before',
                        fill: false,
                        order: 0
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: { ...commonOptions.scales, y: { type: 'linear', title: { display: true, text: '%' }}},
                    plugins: { 
                        ...commonOptions.plugins, 
                        title: { display: true, text: 'Hourly Relative Humidity', font: { size: 16 }},
                        legend: { display: false }
                    }
                }
            });
        }

        // --- Heatmap Logic ---
        function prepareHeatmapData() {
            if (heatmapDataCache) return heatmapDataCache;

            const y_labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);
            const daysInYear = Math.floor(epwData.length / 24);

            const z_temp = Array.from({ length: 24 }, () => new Array(daysInYear).fill(null));
            const z_humidity = Array.from({ length: 24 }, () => new Array(daysInYear).fill(null));
            
            // --- Generate X-axis labels and ticks ---
            const x_labels = []; // Full labels for data mapping: "Jan 1", "Jan 2"...
            const x_tickvals = []; // Position for ticks: "Jan 15", "Feb 14"...
            const x_ticktext = []; // Display text for ticks: "Jan", "Feb"...
            let lastMonth = -1;
            let monthStartIndex = 0;

            for (let i = 0; i < daysInYear; i++) {
                const date = epwData[i * 24].date;
                const currentMonth = date.getMonth();
                const monthName = date.toLocaleString('default', { month: 'short' });
                const day = date.getDate();
                const fullLabel = `${monthName} ${day}`;
                x_labels.push(fullLabel);

                if (currentMonth !== lastMonth && lastMonth !== -1) {
                    // New month detected. Find the middle of the *previous* month for the label.
                    const monthEndIndex = i - 1;
                    const middleIndex = Math.floor((monthStartIndex + monthEndIndex) / 2);
                    x_tickvals.push(x_labels[middleIndex]);
                    x_ticktext.push(epwData[monthStartIndex * 24].date.toLocaleString('default', { month: 'short' }));
                    monthStartIndex = i;
                }
                lastMonth = currentMonth;
            }
            // Add the last month after the loop finishes
            const lastMonthEndIndex = daysInYear - 1;
            const middleIndex = Math.floor((monthStartIndex + lastMonthEndIndex) / 2);
            x_tickvals.push(x_labels[middleIndex]);
            x_ticktext.push(epwData[monthStartIndex * 24].date.toLocaleString('default', { month: 'short' }));
            // --- End of label generation ---

            epwData.forEach((dataPoint, index) => {
                const dayIndex = Math.floor(index / 24);
                const hourIndex = index % 24;
                
                if (dayIndex < daysInYear) {
                    z_temp[hourIndex][dayIndex] = dataPoint.temp;
                    z_humidity[hourIndex][dayIndex] = dataPoint.humidity;
                }
            });
            
            heatmapDataCache = { x_labels, y_labels, z_temp, z_humidity, x_tickvals, x_ticktext };
            return heatmapDataCache;
        }

        function displayHeatmaps(tempRange = {}, humidityRange = {}) {
            if (epwData.length === 0) return;
            const { x_labels, y_labels, z_temp, z_humidity, x_tickvals, x_ticktext } = prepareHeatmapData();

            const commonLayout = {
                margin: { l: 50, r: 20, b: 70, t: 50, pad: 4 },
                xaxis: { 
                    title: 'Day of the Year', 
                    tickmode: 'array',
                    tickvals: x_tickvals,
                    ticktext: x_ticktext,
                    tickangle: 0
                },
                yaxis: { title: 'Hour of the Day' }
            };

            const tempTrace = {
                z: z_temp, x: x_labels, y: y_labels,
                type: 'heatmap', colorscale: 'RdBu', reversescale: false,
                zmin: tempRange.min, zmax: tempRange.max,
                zauto: tempRange.min === undefined && tempRange.max === undefined
            };
            const tempLayout = { ...commonLayout, title: '<b>Temperature Heatmap (°C)</b>' };
            Plotly.newPlot('temp-heatmap', [tempTrace], tempLayout, {responsive: true});

            const humidityTrace = {
                z: z_humidity, x: x_labels, y: y_labels,
                type: 'heatmap', colorscale: 'YlGnBu', reversescale: true,
                zmin: humidityRange.min, zmax: humidityRange.max,
                zauto: humidityRange.min === undefined && humidityRange.max === undefined
            };
            const humidityLayout = { ...commonLayout, title: '<b>Relative Humidity Heatmap (%)</b>' };
            Plotly.newPlot('humidity-heatmap', [humidityTrace], humidityLayout, {responsive: true});
        }
        
        updateHeatmapBtn.addEventListener('click', () => {
            const t_min = parseFloat(document.getElementById('temp-min-input').value) || undefined;
            const t_max = parseFloat(document.getElementById('temp-max-input').value) || undefined;
            const h_min = parseFloat(document.getElementById('humidity-min-input').value) || undefined;
            const h_max = parseFloat(document.getElementById('humidity-max-input').value) || undefined;
            displayHeatmaps({min: t_min, max: t_max}, {min: h_min, max: h_max});
        });

        resetHeatmapBtn.addEventListener('click', () => {
             document.getElementById('temp-min-input').value = '';
             document.getElementById('temp-max-input').value = '';
             document.getElementById('humidity-min-input').value = '';
             document.getElementById('humidity-max-input').value = '';
             displayHeatmaps();
        });
        
        // --- Summary Logic ---
        function calculateAndDisplaySummary() {
            if (epwData.length === 0) return;
            
            const temps = epwData.map(d => d.temp);
            const humidities = epwData.map(d => d.humidity);

            const sumTemp = temps.reduce((a, b) => a + b, 0);
            const sumHumidity = humidities.reduce((a, b) => a + b, 0);

            document.getElementById('avg-temp').textContent = (sumTemp / temps.length).toFixed(2);
            document.getElementById('max-temp').textContent = Math.max(...temps).toFixed(2);
            document.getElementById('min-temp').textContent = Math.min(...temps).toFixed(2);
            
            document.getElementById('avg-humidity').textContent = (sumHumidity / humidities.length).toFixed(2);
            document.getElementById('max-humidity').textContent = Math.max(...humidities).toFixed(2);
            document.getElementById('min-humidity').textContent = Math.min(...humidities).toFixed(2);
            
            // Calculate IMAC comfort percentage
            let comfortHours = 0;
            epwData.forEach(d => {
                const month = d.date.getMonth();
                const limits = imacLimits[month];
                if (d.temp >= limits.lower && d.temp <= limits.upper) {
                    comfortHours++;
                }
            });
            const comfortPercentage = (comfortHours / epwData.length) * 100;
            document.getElementById('comfort-percentage').textContent = `${comfortPercentage.toFixed(2)}%`;
        }

    </script>
</body>
</html>




